// internal/views/pages/Dashboard.templ
package pages

import (
	"fmt"
	"maestro/internal/models"
	"maestro/internal/views/components"
	"maestro/internal/views/layouts"
	"maestro/internal/views/ui"
	"time"
)

templ Dashboard(
	stats models.DashboardStats,
	todayCount int,
	overdueCount int,
	upcomingCount int,
	overdue []models.Exercise,
	upcoming []models.Exercise,
) {
	@layouts.Base("Analytics Dashboard - Maestro") {
		<div class="relative min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950">
			<!-- Ambient Effects -->
			<div class="pointer-events-none absolute inset-0 overflow-hidden opacity-40">
				<div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_20%,_rgba(56,189,248,0.1),_transparent_50%)]"></div>
				<div class="absolute inset-0 bg-[radial-gradient(circle_at_70%_80%,_rgba(168,85,247,0.1),_transparent_50%)]"></div>
			</div>
			<div class="relative z-10 max-w-[1920px] mx-auto px-6 py-8 space-y-6">
				<!-- ============================================ -->
				<!-- HERO: Header + Quick Actions -->
				<!-- ============================================ -->
				<div class="flex items-center justify-between mb-8">
					@ui.TerminalHeaderWithDate("MISSION_CONTROL.ANALYTICS", time.Now(), ui.HeaderSky)
					<!-- Quick Actions -->
					<div class="flex items-center gap-3">
						<!-- CTA primaire : Start Session -->
						<a
							href="/session/builder"
							class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-emerald-600/60 bg-emerald-950/40 text-emerald-300 
                            font-mono text-xs uppercase tracking-wider hover:bg-emerald-900/60 hover:border-emerald-500 transition-all"
							hx-boost="true"
						>
							<span class="text-xl animate-pulse">âš¡</span>
							<span>START SESSION</span>
						</a>
						<!-- CTA secondaire : Planner -->
						<a
							href="/exercises/new"
							class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-slate-700 bg-slate-900/80 text-slate-300 
                            font-mono text-xs uppercase tracking-wider hover:border-sky-500/60 hover:bg-slate-800 transition-all"
							hx-boost="true"
						>
							<span>+</span>
							<span>NEW EXERCISE</span>
						</a>
					</div>
				</div>
				<!-- ============================================ -->
				<!-- KPI GRID: 4 metrics stratÃ©giques (NO DUPLICATION) -->
				<!-- ============================================ -->
				<div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
					<!-- âŒ REMOVED: TODAY (dÃ©jÃ  dans Planner sidebar) -->
					<!-- âŒ REMOVED: OVERDUE (dÃ©jÃ  dans Planner sidebar) -->
					<!-- âœ… KEEP: Long-term metrics only -->
					@components.KPICard("STREAK", stats.StreakDays, "days", "ðŸ”¥", stats.StreakDays >= 7, "/planner", 0)
					@components.KPICard("RETENTION", stats.RetentionRate, "%", "ðŸ§ ", stats.RetentionRate < 70, "/exercises?sort=retention", 0)
					@components.KPICard("MASTERED", stats.TotalMastered, fmt.Sprintf("/%d", stats.TotalExercises), "âœ“", false, "/exercises?status=mastered", stats.CompletionRate)
					@components.KPICard("AVG_EASE", int(stats.AverageEaseFactor*100), "/500", "ðŸ“Š", stats.AverageEaseFactor < 2.5, "/exercises?sort=difficulty", 0)
				</div>
				<!-- ============================================ -->
				<!-- TOP SECTION: Heatmap + Focus -->
				<!-- ============================================ -->
				<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
					<!-- Retention Curve -->
					@components.RetentionCurveCard(stats)
					<!-- Review Distribution -->
					@components.FocusRecommendationCard(stats)
				</div>
			</div>
			<!-- ============================================ -->
			<!-- MAIN GRID: Performance + Analytics -->
			<!-- ============================================ -->
			<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
				<!-- ===== COLONNE 1: Velocity + Performance ===== -->
				<div class="space-y-6">
					<!-- Learning Velocity (30d) -->
					@components.LearningVelocityCard(stats)
					<!-- Performance Matrix -->
					@components.PerformanceCard(stats)
				</div>
				<!-- ===== COLONNE 2: SRS + Insights ===== -->
				<div class="space-y-6">
					<!-- SRS Health -->
					@components.SRSHealthCard(stats)
					<!-- AI Insights -->
					@components.InsightsCard(stats, todayCount, overdueCount)
				</div>
				<!-- ===== COLONNE 3: Weaknesses + Domains ===== -->
				<div class="space-y-6">
					<!-- Weak Exercises -->
					@components.WeaknessCard(stats)
					<!-- Domain Strength -->
					@components.DomainStrengthCard(stats)
				</div>
			</div>
			<!-- ============================================ -->
			<!-- BOTTOM: Advanced Analytics -->
			<!-- ============================================ -->
		</div>
	}
}
